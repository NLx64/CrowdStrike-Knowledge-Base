#type="microsoft-entra-id"
// VALIDAÃ‡ÃƒO INICIAL
| Vendor.properties.userAgent != null

// MATCH COM CSV - Com valores default  // essa parte do match com csv Ã© opcional, vc pode usar outro fator para a regra, para usar a regra com o match, precisa importar o arquivo de lookup. na console UserAgent-Blacklist.csv
| match(file="UserAgent-Blacklist.csv", field=Vendor.properties.userAgent, include=[Category, Severity])
| case {
    Category = null | Category := "Unknown" ;
    * | Category := Category ;
}
| case {
    Severity = null | Severity := "Gray" ;
    * | Severity := Severity ;
}

// CAMPOS BASE
| mfaStatus := Vendor.properties.authenticationRequirement
| resultType := Vendor.properties.resultType
| errorCode := Vendor.properties.status.errorCode
| resultSig := Vendor.resultSignature
| authProtocol := Vendor.properties.authenticationProtocol
| authStepDetail := Vendor.properties.authenticationDetails[0].authenticationStepResultDetail

// TIMEZONE
| DataHora := formatTime(format="%Y-%m-%d %H:%M:%S", field=@timestamp, timezone="America/Sao_Paulo")

// STATUS DA SENHA
| case {
    // PRIORIDADE 1: authStepDetail especÃ­ficos
    authStepDetail = "Correct password" | StatusSenha := "ğŸš¨ SENHA COMPROMETIDA" ;
    authStepDetail = "Incorrect password" | StatusSenha := "âŒ SENHA INCORRETA" ;
    authStepDetail = "Invalid username or password or Invalid on-premise username or password." | StatusSenha := "âŒ CREDENCIAL INVÃLIDA" ;
    authStepDetail = "MFA required in Azure AD" | StatusSenha := "âœ… SENHA CORRETA (MFA salvou)" ;
    authStepDetail = "MFA requirement satisfied by claim in the token" | StatusSenha := "âœ… TOKEN MFA VÃLIDO" ;
    authStepDetail = "User account is disabled. The account has been disabled by an administrator." | StatusSenha := "ğŸš« CONTA DESABILITADA" ;
    
    // PRIORIDADE 2: authStepDetail existe mas nÃ£o mapeado
    authStepDetail != null AND authStepDetail != "" | StatusSenha := "âš ï¸ AUTH: " + authStepDetail ;
    
    // PRIORIDADE 3: Fallback por errorCode
    errorCode = 50126 | StatusSenha := "âŒ SENHA INCORRETA (erro)" ;
    errorCode = 50076 | StatusSenha := "âš ï¸ MFA REQUERIDO" ;
    errorCode = 50053 | StatusSenha := "ğŸ”’ CONTA BLOQUEADA" ;
    errorCode = 50057 | StatusSenha := "ğŸš« CONTA DESABILITADA" ;
    
    // PRIORIDADE 4: Fallback por resultado
    resultType = 0 AND resultSig = "SUCCESS" | StatusSenha := "âœ… ACESSO PERMITIDO" ;
    resultSig = "FAILURE" | StatusSenha := "âŒ FALHA: " + errorCode ;
    resultSig = "SUCCESS" | StatusSenha := "âœ… SUCESSO" ;
    
    // DEFAULT
    * | StatusSenha := "âš ï¸ VERIFICAR" ;
}

// MFA STATUS
| case {
    mfaStatus = "multiFactorAuthentication" | StatusMFA := "âœ… COM MFA" ;
    mfaStatus = "singleFactorAuthentication" | StatusMFA := "âŒ SEM MFA" ;
    * | StatusMFA := "âš ï¸ NÃƒO IDENTIFICADO" ;
}

// ACESSO REAL
| case {
    resultType = 0 AND resultSig = "SUCCESS" | AcessoReal := "âœ… ACESSO TOTAL CONFIRMADO" ;
    resultType = 0 | AcessoReal := "âœ… ACESSO PERMITIDO" ;
    resultSig = "SUCCESS" | AcessoReal := "âš ï¸ SUCESSO PARCIAL" ;
    resultSig = "FAILURE" | AcessoReal := "âŒ BLOQUEADO" ;
    * | AcessoReal := "â“ VERIFICAR" ;
}

// POLÃTICA - ABORDAGEM DIRETA (sem array:eval)
| policyName := "Nenhuma"
| policyResult := "none"

// Verificar polÃ­ticas em ordem de prioridade - FALHAS primeiro
| case {
    Vendor.properties.appliedConditionalAccessPolicies[0].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[0].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[0].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[0].result ;
    
    Vendor.properties.appliedConditionalAccessPolicies[1].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[1].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[1].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[1].result ;
    
    Vendor.properties.appliedConditionalAccessPolicies[2].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[2].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[2].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[2].result ;
    
    Vendor.properties.appliedConditionalAccessPolicies[3].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[3].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[3].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[3].result ;
    
    Vendor.properties.appliedConditionalAccessPolicies[4].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[4].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[4].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[4].result ;
    
    Vendor.properties.appliedConditionalAccessPolicies[5].result = "reportOnlyFailure" OR Vendor.properties.appliedConditionalAccessPolicies[5].result = "failure" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[5].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[5].result ;
    
    // Se nÃ£o encontrou falhas, pegar polÃ­ticas com sucesso
    policyName = "Nenhuma" AND Vendor.properties.appliedConditionalAccessPolicies[0].result = "success" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[0].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[0].result ;
    
    policyName = "Nenhuma" AND Vendor.properties.appliedConditionalAccessPolicies[1].result = "success" |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[1].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[1].result ;
    
    // Se ainda nÃ£o encontrou, pegar qualquer polÃ­tica disponÃ­vel
    policyName = "Nenhuma" AND Vendor.properties.appliedConditionalAccessPolicies[0].displayName != null |
        policyName := Vendor.properties.appliedConditionalAccessPolicies[0].displayName ;
        policyResult := Vendor.properties.appliedConditionalAccessPolicies[0].result ;
    
    * | policyName := policyName ; policyResult := policyResult ;
}

// STATUS DA POLÃTICA
| case {
    policyResult = "reportOnlyFailure" | PolicyStatus := "ğŸ”´ DETECTADO MAS NÃƒO BLOQUEADO" ;
    policyResult = "reportOnlyNotApplied" | PolicyStatus := "âšª NÃƒO APLICADA (REPORT-ONLY)" ;
    policyResult = "failure" | PolicyStatus := "ğŸš« BLOQUEADO POR POLÃTICA" ;
    policyResult = "success" | PolicyStatus := "âœ… POLÃTICA APLICADA" ;
    policyResult = "notApplied" | PolicyStatus := "âšª NÃƒO APLICADA" ;
    policyResult = "notEnabled" | PolicyStatus := "âš« DESABILITADA" ;
    * | PolicyStatus := "â“ SEM POLÃTICA" ;
}

// DETECTAR CONTAS DE SERVIÃ‡O usando regex()
| isServiceAccount := false
| case {
    regex("(robo|rpa|servico|integracao|api|svc-|srv-)", field=user.email) | isServiceAccount := true ;
    * | isServiceAccount := false ;
}

// CRITICIDADE - LÃ³gica completa
| case {
    // ğŸš¨ğŸš¨ğŸš¨ EMERGÃŠNCIA MÃXIMA
    authStepDetail = "Correct password" AND mfaStatus = "singleFactorAuthentication" | 
      Criticidade := "ğŸš¨ğŸš¨ğŸš¨ EMERGÃŠNCIA - SENHA COMPROMETIDA SEM MFA" ;
    
    authStepDetail = "Correct password" AND isServiceAccount = true | 
      Criticidade := "ğŸš¨ğŸš¨ğŸš¨ EMERGÃŠNCIA - CONTA DE SERVIÃ‡O COMPROMETIDA" ;
    
    authStepDetail = "Correct password" AND source.geo.country_name != "BR" | 
      Criticidade := "ğŸš¨ğŸš¨ğŸš¨ EMERGÃŠNCIA - SENHA COMPROMETIDA INTERNACIONAL" ;
    
    authStepDetail = "Correct password" | 
      Criticidade := "ğŸš¨ğŸš¨ CRÃTICO - SENHA COMPROMETIDA" ;
    
    // ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - MFA salvou mas senha estÃ¡ comprometida
    authStepDetail = "MFA required in Azure AD" AND source.geo.country_name != "BR" | 
      Criticidade := "ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - Senha correta internacional (MFA salvou)" ;
    
    authStepDetail = "MFA required in Azure AD" AND Severity = "Red" | 
      Criticidade := "ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - Password spray acertou senha (MFA salvou)" ;
    
    authStepDetail = "MFA required in Azure AD" | 
      Criticidade := "ğŸ”´ğŸ”´ ALTO - Senha correta mas MFA protegeu" ;
    
    // ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - Acessos bem-sucedidos suspeitos
    resultType = 0 AND mfaStatus = "singleFactorAuthentication" AND source.geo.country_name != "BR" AND PolicyStatus = "ğŸ”´ DETECTADO MAS NÃƒO BLOQUEADO" | 
      Criticidade := "ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - Acesso internacional sem MFA, polÃ­tica apenas em report" ;
    
    resultType = 0 AND mfaStatus = "singleFactorAuthentication" AND source.geo.country_name != "BR" | 
      Criticidade := "ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - Acesso internacional sem MFA" ;
    
    resultType = 0 AND mfaStatus = "singleFactorAuthentication" AND Severity = "Red" | 
      Criticidade := "ğŸ”´ğŸ”´ğŸ”´ CRÃTICO - User agent malicioso + sem MFA + sucesso" ;
    
    // ğŸ”´ğŸ”´ ALTO
    resultType = 0 AND mfaStatus = "multiFactorAuthentication" AND source.geo.country_name != "BR" AND Severity = "Red" | 
      Criticidade := "ğŸ”´ğŸ”´ ALTO - Internacional + MFA + user agent suspeito" ;
    
    resultType = 0 AND mfaStatus = "singleFactorAuthentication" AND PolicyStatus = "ğŸ”´ DETECTADO MAS NÃƒO BLOQUEADO" | 
      Criticidade := "ğŸ”´ğŸ”´ ALTO - Sem MFA + polÃ­tica nÃ£o bloqueou" ;
    
    resultType = 0 AND mfaStatus = "singleFactorAuthentication" | 
      Criticidade := "ğŸ”´ğŸ”´ ALTO - Qualquer sucesso sem MFA Ã© risco" ;
    
    resultType = 0 AND source.geo.country_name != "BR" | 
      Criticidade := "ğŸ”´ğŸ”´ ALTO - Acesso internacional (mesmo com MFA)" ;
    
    // ğŸ”´ MÃ‰DIO
    resultType = 0 AND mfaStatus = "multiFactorAuthentication" AND Severity = "Red" | 
      Criticidade := "ğŸ”´ MÃ‰DIO - User agent suspeito mas com MFA" ;
    
    resultType = 0 AND mfaStatus = "multiFactorAuthentication" AND PolicyStatus = "ğŸ”´ DETECTADO MAS NÃƒO BLOQUEADO" | 
      Criticidade := "ğŸ”´ MÃ‰DIO - Com MFA mas polÃ­tica detectou anomalia" ;
    
    resultType = 0 AND Severity = "Yellow" | 
      Criticidade := "ğŸ”´ MÃ‰DIO - Sucesso com severidade moderada" ;
    
    resultType = 0 | 
      Criticidade := "ğŸ”´ MÃ‰DIO - Sucesso (verificar contexto)" ;
    
    // ğŸŸ¡ ATENÃ‡ÃƒO
    errorCode = 50126 AND source.geo.country_name != "BR" | 
      Criticidade := "ğŸŸ¡ ATENÃ‡ÃƒO - Tentativa de senha internacional" ;
    
    errorCode = 50126 AND Severity = "Red" | 
      Criticidade := "ğŸŸ¡ ATENÃ‡ÃƒO - Password spray detectado" ;
    
    errorCode = 50076 | 
      Criticidade := "ğŸŸ¡ ATENÃ‡ÃƒO - MFA challenge (possÃ­vel comprometimento de senha)" ;
    
    errorCode = 50053 | 
      Criticidade := "ğŸŸ¡ ATENÃ‡ÃƒO - Conta bloqueada (possÃ­vel ataque)" ;
    
    PolicyStatus = "ğŸš« BLOQUEADO POR POLÃTICA" | 
      Criticidade := "ğŸŸ¡ ATENÃ‡ÃƒO - PolÃ­tica bloqueou (verificar motivo)" ;
    
    // âšª BAIXO
    errorCode = 50126 | 
      Criticidade := "âšª BAIXO - Senha incorreta" ;
    
    errorCode = 50057 | 
      Criticidade := "âšª BAIXO - Conta desabilitada" ;
    
    * | 
      Criticidade := "âšª BAIXO - Outros casos" ;
}

// DESCRIÃ‡ÃƒO DETALHADA
| DetalhesAtaque := format(format="ğŸš¨ LOGIN SUSPEITO - USER AGENT MALICIOSO ğŸš¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ†’ USUÃRIO: %s (ID: %s)\nâ†’ USER AGENT MALICIOSO: %s\n   â””â”€ CATEGORIA: %s | SEVERIDADE: %s\nâ†’ ORIGEM DO ATAQUE:\n   â””â”€ IP: %s (ASN: %s)\n   â””â”€ LOCALIZAÃ‡ÃƒO: %s, %s\n   â””â”€ COORDENADAS: [%s, %s]\nâ†’ SEGURANÃ‡A:\n   â””â”€ AUTENTICAÃ‡ÃƒO: %s\n   â””â”€ STATUS SENHA: %s\n   â””â”€ DETALHE AUTH: %s\n   â””â”€ ACESSO: %s\n   â””â”€ NÃVEL DE RISCO: %s\n   â””â”€ RESULTADO: %s (CÃ³digo: %s)\nâ†’ POLÃTICA DE BLOQUEIO:\n   â””â”€ POLÃTICA: %s\n   â””â”€ STATUS: %s\nâ†’ RECURSOS ACESSADOS:\n   â””â”€ RECURSO: %s\n   â””â”€ APLICAÃ‡ÃƒO: %s (ID: %s)\nâ†’ DETALHES DA SESSÃƒO:\n   â””â”€ DATA/HORA: %s (UTC-3)\n   â””â”€ SESSÃƒO ID: %s\n   â””â”€ DURAÃ‡ÃƒO: %sms\n   â””â”€ TENANT: %s\n   â””â”€ Ã‰ CONTA DE SERVIÃ‡O: %s\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•", 
    field=[user.email, 
           user.id,
           Vendor.properties.userAgent,
           Category,
           Severity,
           source.ip,
           Vendor.properties.autonomousSystemNumber,
           source.geo.city_name,
           source.geo.country_name,
           source.geo.location.lat,
           source.geo.location.lon,
           mfaStatus,
           StatusSenha,
           authStepDetail,
           AcessoReal,
           Vendor.properties.riskLevelAggregated,       
           resultSig,
           errorCode,
           policyName,
           PolicyStatus,
           Vendor.properties.resourceDisplayName,
           Vendor.properties.appDisplayName,
           Vendor.properties.appId,
           DataHora,
           Vendor.properties.sessionId,
           Vendor.properties.processingTimeInMilliseconds,
           Vendor.tenantId,
           isServiceAccount])

// SELECT FINAL
| select([
    @timestamp,
    Criticidade,
    authStepDetail,
    DetalhesAtaque,
    user.email,
    StatusSenha,
    AcessoReal,
    Vendor.properties.userAgent,
    Category,
    Severity,
    source.ip,
    Vendor.properties.autonomousSystemNumber,
    source.geo.city_name,
    source.geo.country_name,
    StatusMFA,
    PolicyStatus,
    policyName,
    isServiceAccount,
    Vendor.properties.riskLevelAggregated,
    Vendor.properties.resourceDisplayName,
    Vendor.properties.appDisplayName,
    resultSig,
    errorCode,
    Vendor.properties.sessionId,
    Vendor.properties.conditionalAccessStatus
])

// RENOMEAR
| rename(field=user.email, as=Usuario)
| rename(field=Vendor.properties.userAgent, as=UserAgent)
| rename(field=source.ip, as=IPOrigem)
| rename(field=Vendor.properties.autonomousSystemNumber, as=ASN)
| rename(field=source.geo.city_name, as=Cidade)
| rename(field=source.geo.country_name, as=PaÃ­s)
| rename(field=Vendor.properties.riskLevelAggregated, as=NÃ­velRisco)
| rename(field=Vendor.properties.resourceDisplayName, as=RecursoAcessado)
| rename(field=Vendor.properties.appDisplayName, as=AplicaÃ§Ã£o)
| rename(field=resultSig, as=ResultadoFinal)
| rename(field=errorCode, as=CÃ³digoErro)
| rename(field=Vendor.properties.sessionId, as=IDSessÃ£o)
| rename(field=Vendor.properties.conditionalAccessStatus, as=StatusCA)
| rename(field=authStepDetail, as=DetalheAutenticaÃ§Ã£o)
| rename(field=policyName, as=PolÃ­ticaAplicada)
| rename(field=isServiceAccount, as=ContaDeServiÃ§o)

// ORDENAR
| sort(@timestamp, reverse=true, limit=200000)
